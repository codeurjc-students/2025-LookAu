name: CI/CD - Test, Sonar & Docker

on:
  push:
    branches: [ "dev", "main" ]
  pull_request:
    branches: [ "main" ]


jobs:

  #TEST - BACKEND
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven

      - name: Run backend tests (excluding Selenium)
        working-directory: backend
        run: mvn -B verify -Dgroups=!selenium


  #TEST - FRONTEND
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-22.04
    needs: backend-tests
    
    steps:
    - uses: actions/checkout@v4

    # --- Java ---
    - name: Set up Java 18
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 18

    # --- Chromium ---
    - name: Install Chromium (prevent auto-updates)
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser
        sudo apt-mark hold chromium-browser
        sudo apt-mark hold google-chrome-stable

    # --- Docker: MySQL ---
    - name: Set up Docker MySQL container
      run: |
        sudo docker run -d \
          --name lookau-mysql-ci \
          -p 3306:3306 \
          -e MYSQL_DATABASE=lookau_test \
          -e MYSQL_ROOT_PASSWORD=password \
          mysql:8.3.0

    # --- Dockerize para esperar DB ---
    - name: Install Dockerize
      run: curl -sSL https://github.com/jwilder/dockerize/releases/download/v0.6.1/dockerize-linux-amd64-v0.6.1.tar.gz | sudo tar -C /usr/local/bin -xzv

    - name: Wait for MySQL to start
      run: dockerize -wait tcp://localhost:3306 -timeout 1m

    # --- Environment variables ---
    - name: Set environment variables
      run: |
        echo "GMAIL_USERNAME=${{ secrets.GMAIL_USERNAME }}" >> $GITHUB_ENV
        echo "GMAIL_PASSWORD=${{ secrets.GMAIL_PASSWORD }}" >> $GITHUB_ENV

    # --- env.properties ---
    - name: Create env.properties file
      run: |
        echo "GMAIL_USERNAME=${{ secrets.GMAIL_USERNAME }}" > backend/src/main/resources/env.properties
        echo "GMAIL_PASSWORD=${{ secrets.GMAIL_PASSWORD }}" >> backend/src/main/resources/env.properties

    # --- Line endings fix ---
    - name: Convert line endings to Unix format
      run: sed -i 's/\r$//' backend/mvnw

    # --- Make mvnw executable ---
    - name: Make mvnw executable
      run: chmod +x backend/mvnw

    # --- Build backend ---
    - name: Build with Maven
      run: backend/mvnw -B package --file backend/pom.xml -DskipTests

    # --- Run backend ---
    - name: Run backend
      run: |
        nohup backend/mvnw spring-boot:run -Dspring-boot.run.profiles=test --file backend/pom.xml > backend.log 2>&1 &
        echo "Waiting for backend to start..."
        for i in {1..120}; do
          nc -z localhost 8080 && echo "Backend ready" && break
          sleep 1
        done
    - name: Show backend logs
      run: cat backend/backend.log || true

    # --- Node.js ---
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    # --- Angular CLI ---
    - name: Install Angular CLI
      run: npm install -g @angular/cli
      working-directory: frontend

    - name: Do not share Angular CLI telemetry
      run: ng analytics off
      working-directory: frontend

    - name: Install frontend dependencies
      run: npm install
      working-directory: frontend

    # --- Run Angular app ---
    - name: Run Angular application
      run: |
        nohup ng serve --host 0.0.0.0 --port 4200 --proxy-config proxy.ci.conf.json > frontend.log 2>&1 &
        echo "Waiting for frontend to start..."
        # Esperar hasta que Angular exponga /signup
        for i in {1..60}; do
          status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:4200/signup || echo "000")
          if [ "$status" == "200" ]; then
            echo "Frontend listo"
            break
          fi
          sleep 2
        done

    - name: Show frontend logs
      run: cat frontend/frontend.log || true

    # --- Selenium tests ---
    - name: Run Selenium tests
      run: backend/mvnw test -P selenium-tests --file backend/pom.xml


  #SONAR
  sonar-analysis:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: frontend-tests
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: SonarCloud Scan
        working-directory: backend
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B verify -Dgroups=!selenium sonar:sonar \
            -Dsonar.projectKey=codeurjc-students_2025-LookAu \
            -Dsonar.organization=codeurjc-students \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.branch.name=${GITHUB_REF_NAME##*/}


  #DOCKER DEPLOY
  publish-docker:
    name: Publish Docker
    runs-on: ubuntu-latest
    needs: sonar-analysis
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    steps:
      - uses: actions/checkout@v4

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image
        working-directory: ./docker
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/lookau:${{ github.sha }} -f Dockerfile ..

      - name: Tag as PR build
        run: docker tag ${{ secrets.DOCKERHUB_USERNAME }}/lookau:${{ github.sha }} ${{ secrets.DOCKERHUB_USERNAME }}/lookau:pr-${{ github.event.pull_request.number }}

      - name: Push Docker image to DockerHub
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/lookau:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/lookau:pr-${{ github.event.pull_request.number }}
