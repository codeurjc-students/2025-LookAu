name: CI/CD - Test, Sonar & Docker

on:
  push:
    branches: [ "dev", "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  #TEST - BACKEND
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven

      - name: Run backend tests (excluding Selenium)
        working-directory: backend
        run: mvn -B verify -Dgroups=!selenium

  #TEST - FRONTEND
  frontend-tests:
    name: Frontend/Selenium Tests
    runs-on: ubuntu-22.04
    needs: backend-tests
    steps:
      - uses: actions/checkout@v2

      - name: Set up JDK 18
        uses: actions/setup-java@v2
        with:
          distribution: adopt
          java-version: 18

      - name: Install Chromium
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser
          sudo apt-mark hold chromium-browser
          sudo apt-mark hold google-chrome-stable

      - name: Set up Docker (MySQL)
        run: sudo docker run -d --name bookmarks-forums-DB-GitHub-actions-selenium -p 3306:3306 -e MYSQL_DATABASE=BFDB -e MYSQL_ROOT_PASSWORD=password mysql:8.3.0

      - name: Install Dockerize
        run: curl -sSL https://github.com/jwilder/dockerize/releases/download/v0.6.1/dockerize-linux-amd64-v0.6.1.tar.gz | sudo tar -C /usr/local/bin -xzv

      - name: Wait for MySQL to start
        run: dockerize -wait tcp://localhost:3306 -timeout 1m

      - name: Set environment variables
        run: |
          echo "GMAIL_USERNAME=${{ secrets.GMAIL_USERNAME }}" >> $GITHUB_ENV
          echo "GMAIL_PASSWORD=${{ secrets.GMAIL_PASSWORD }}" >> $GITHUB_ENV

      - name: Create env.properties file
        run: |
          echo "GMAIL_USERNAME=${{ secrets.GMAIL_USERNAME }}" > backend/src/main/resources/env.properties
          echo "GMAIL_PASSWORD=${{ secrets.GMAIL_PASSWORD }}" >> backend/src/main/resources/env.properties

      - name: Convert line endings to Unix format
        run: sed -i 's/\r$//' backend/mvnw

      - name: Make mvnw executable
        run: chmod +x backend/mvnw

      - name: Build backend
        run: backend/mvnw -B package --file backend/pom.xml -DskipTests

      - name: Run backend application
        run: |
          nohup backend/mvnw spring-boot:run --file backend/pom.xml &
          sleep 10

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Angular CLI
        run: npm install -g @angular/cli
        working-directory: frontend

      - name: Disable Angular CLI telemetry
        run: ng analytics off
        working-directory: frontend

      - name: Install frontend dependencies
        run: npm install
        working-directory: frontend

      - name: Run Angular app
        run: |
          nohup ng serve &
          sleep 30
        working-directory: frontend

      - name: Run Selenium tests
        run: backend/mvnw test -P selenium-tests --file backend/pom.xml

  #SONAR
  sonar-analysis:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: frontend-tests
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: SonarCloud Scan
        working-directory: backend
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B verify -Dgroups=!selenium sonar:sonar \
            -Dsonar.projectKey=codeurjc-students_2025-LookAu \
            -Dsonar.organization=codeurjc-students \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.branch.name=${GITHUB_REF_NAME##*/}

  #DOCKER DEPLOY
  publish-docker:
    name: Publish Docker
    runs-on: ubuntu-latest
    needs: sonar-analysis
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    steps:
      - uses: actions/checkout@v4

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image
        working-directory: ./docker
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/lookau:${{ github.sha }} -f Dockerfile ..

      - name: Tag as PR build
        run: docker tag ${{ secrets.DOCKERHUB_USERNAME }}/lookau:${{ github.sha }} ${{ secrets.DOCKERHUB_USERNAME }}/lookau:pr-${{ github.event.pull_request.number }}

      - name: Push Docker image to DockerHub
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/lookau:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/lookau:pr-${{ github.event.pull_request.number }}
